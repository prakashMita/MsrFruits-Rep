import React, { useState, useCallback, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import axios from 'axios';

function ReportRight() {
  const location = useLocation();
  const { OrderId, UserName, UserMobile, status } = location.state || {};

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [customers, setCustomers] = useState([]);
  const [selectedOrder, setSelectedOrder] = useState([]);
  const [showViewButton, setShowViewButton] = useState(true);
  const [orderIdFilter, setOrderIdFilter] = useState('');
  const [userNameFilter, setUserNameFilter] = useState('');
  const [statusFilter, setStatusFilter] = useState('');

  const [amounts, setAmounts] = useState({});
  const [isFilteringByToday, setIsFilteringByToday] = useState(false);
  const [isFilteringByLast7Days, setIsFilteringByLast7Days] = useState(false);  // Add this line

  const [isMonthModalOpen, setIsMonthModalOpen] = useState(false);
  const [selectedMonth, setSelectedMonth] = useState('');


  const [fromDate, setFromDate] = useState('');
const [toDate, setToDate] = useState('');


  const handleOpenModal = () => setIsModalOpen(true);
  const handleCloseModal = () => {
    setIsModalOpen(false);
    setShowViewButton(true);
  };

  useEffect(() => {
    fetchAllData(); // Fetch all data by default
  }, []);

  const fetchAllData = async () => {
    try {
      const response = await axios.get('http://localhost:8081/customerlist');
      const uniqueCustomers = getUniqueCustomers(response.data);
      setCustomers(uniqueCustomers);
     
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  };
  
  const fetchDataByPeriod = async (startDate, endDate) => {
    try {
      const response = await axios.get('http://localhost:8081/customerlist', {
        params: { startDate, endDate }
      });
      console.log('Fetched customers:', response.data); // Add this line to debug
      const uniqueCustomers = getUniqueCustomers(response.data);
      setCustomers(uniqueCustomers);
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  };

  const handleViewClick = async (orderId) => {
    setShowViewButton(false);
    setIsModalOpen(true);
    try {
      const response = await axios.get(`http://localhost:8081/customerlist/${orderId}`);
      setSelectedOrder(response.data || []);
    } catch (error) {
      if (error.response && error.response.status === 404) {
        alert(`Order with ID ${orderId} not found.`);
      } else {
        alert('An error occurred while fetching the order details.');
      }
      setSelectedOrder([]);
    }
  };

  const getUniqueCustomers = (data) => {
    const seen = new Set();
    return data.filter((customer) => {
      const duplicate = seen.has(customer.OrderId);
      seen.add(customer.OrderId);
      return !duplicate;
    });
  };

  const fetchYearData = () => {
    setIsFilteringByToday(false);
    setIsFilteringByLast7Days(false);  // Reset this state
    const currentYear = new Date().getFullYear();
    const startDate = `${currentYear}-01-01`;
    const endDate = `${currentYear}-12-31`;
    fetchDataByPeriod(startDate, endDate);
  };

  const fetchCurrentWeekData = () => {
    const today = new Date();
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 7);
    const startDate = sevenDaysAgo.toISOString().split('T')[0];
    const endDate = today.toISOString().split('T')[0];
    fetchDataByPeriod(startDate, endDate);
    setIsFilteringByLast7Days(true);  // Set this state
  };

  const fetchTodayData = () => {
    const today = new Date();
    const todayDate = today.toISOString().split('T')[0];
    
    setIsFilteringByToday(true);
    setIsFilteringByLast7Days(false);  // Reset this state
    fetchDataByPeriod(todayDate, todayDate);
  };

  const handleMonthModalOpen = () => setIsMonthModalOpen(true);
  const handleMonthModalClose = () => setIsMonthModalOpen(false);

  const handleMonthChange = (event) => {
    setSelectedMonth(event.target.value);
    setIsMonthModalOpen(false);
    fetchMonthData(event.target.value);
  };

  const fetchMonthData = (month) => {
    const startDate = `${month}-01`;
    const endDate = new Date(new Date(month).setMonth(new Date(month).getMonth() + 1)).toISOString().split('T')[0];
    fetchDataByPeriod(startDate, endDate);
  };

  const filteredCustomers = customers.filter(customer => {
    const matchesOrderId = orderIdFilter ? customer.OrderId.toString().includes(orderIdFilter) : true;
    const matchesUserName = userNameFilter ? customer.UserName.toLowerCase().includes(userNameFilter.toLowerCase()) : true;
    const matchesStatus = statusFilter ? customer.OrderStatus === statusFilter : true;
  
    const customerDate = new Date(customer.created_at).toISOString().split('T')[0];
  
    // Check if we are filtering by today's date
    if (isFilteringByToday) {
      const today = new Date().toISOString().split('T')[0];
      const matchesTodayDate = customerDate === today;
      return matchesOrderId && matchesUserName && matchesStatus && matchesTodayDate;
    }
  
    // Check if we are filtering by the last 7 days
    if (isFilteringByLast7Days) {
      const today = new Date();
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);
      const startDate = sevenDaysAgo.toISOString().split('T')[0];
      const endDate = today.toISOString().split('T')[0];
      const matchesDateRange = customerDate >= startDate && customerDate <= endDate;
      return matchesOrderId && matchesUserName && matchesStatus && matchesDateRange;
    }
  
    // Check if we are filtering by the selected month
    if (selectedMonth) {
      const customerMonth = new Date(customer.created_at).toISOString().slice(0, 7);
      const matchesSelectedMonth = customerMonth === selectedMonth;
      return matchesOrderId && matchesUserName && matchesStatus && matchesSelectedMonth;
    }
  
    // Check if we are filtering by the selected date range
    if (fromDate && toDate) {
      const matchesDateRange = customerDate >= fromDate && customerDate <= toDate;
      return matchesOrderId && matchesUserName && matchesStatus && matchesDateRange;
    }
  
    // Otherwise, filter by the current year
    const currentYear = new Date().getFullYear();
    const customerYear = new Date(customer.created_at).getFullYear();
    const matchesCurrentYear = customerYear === currentYear;
  
    return matchesOrderId && matchesUserName && matchesStatus && matchesCurrentYear;
  });
  

  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };

  useEffect(() => {
    const newAmounts = {};
    filteredCustomers.forEach(customer => {
      const totalAmount = selectedOrder
        .filter(order => order.OrderId === customer.OrderId)
        .reduce((total, item) => total + parseFloat(item.Price || 0), 0)
        .toFixed(2);
      newAmounts[customer.OrderId] = totalAmount;
    });
    setAmounts(newAmounts);
  }, [selectedOrder, filteredCustomers]);

  
  return (
    <div>
      <div className='row'>
        <div className='col-6'>
          <h3 className='my-4'>ORDER REPORTS</h3>
        </div>
        <div className='col-6 my-auto text-end'>
          <div className="text-right my-auto pe-4">
            <h3><strong className='my-auto'>Total Orders:<span className='text-warning'> {filteredCustomers.length}</span></strong></h3>
          </div>
        </div>
      </div>

      <div className='row gap-1  text-center mx-auto'>
        <button onClick={fetchYearData} className='col-2'>Year Report</button>
        <button onClick={handleMonthModalOpen} className='col-2'>Month Report</button>

{/* Month selection modal */}
{isMonthModalOpen && (
  <div className="modal">
    <div className="modal-content">
      <span className="close" onClick={handleMonthModalClose}>&times;</span>
      <h4>Select a Month</h4>
      <input 
        type="month" 
        value={selectedMonth} 
        onChange={handleMonthChange} 
      />
    </div>
  </div>
)}
        <button onClick={fetchCurrentWeekData} className='col-2'>Week Report</button>
        <button onClick={fetchTodayData} className='col-2'>Today Report</button>
        
      </div>

      <form>
  <div className="row">
    <div className="form-group col-md-4 col-4">
      <label htmlFor="orderIdFilter">OrderId</label>
      <input
        id="orderIdFilter"
        type="text"
        placeholder="Filter by Order ID"
        value={orderIdFilter}
        onChange={(e) => setOrderIdFilter(e.target.value)}
      />
    </div>
    <div className="form-group col-md-4 col-4">
      <label htmlFor="userNameFilter">UserName</label>
      <input
        id="userNameFilter"
        type="text"
        placeholder="Filter by Name"
        value={userNameFilter}
        onChange={(e) => setUserNameFilter(e.target.value)}
      />
    </div>
    <div className="form-group col-md-4 col-4">
      <label className='ps-1 m-0'>Status</label>
      <div className='pt-0 m-0'>
        <button
          type="button"
          className={`status-button ${statusFilter === '' ? 'active' : ''}`}
          style={{ marginTop: "0px" }}
          onClick={() => setStatusFilter('')}
        >
          All
        </button>
        <button
          type="button"
          className={`status-button ${statusFilter === 'Paid' ? 'active' : ''}`}
          style={{ marginTop: "0px" }}
          onClick={() => setStatusFilter('Paid')}
        >
          Paid
        </button>
        <button
          type="button"
          className={`status-button ${statusFilter === 'Unpaid' ? 'active' : ''}`}
          style={{ marginTop: "0px" }}
          onClick={() => setStatusFilter('Unpaid')}
        >
          Unpaid
        </button>
      </div>
    </div>
    <div className="form-group col-md-4 col-4">
      <label htmlFor="fromDate">From Date</label>
      <input
        id="fromDate"
        type="date"
        value={fromDate}
        onChange={(e) => setFromDate(e.target.value)}
      />
    </div>
    <div className="form-group col-md-4 col-4">
      <label htmlFor="toDate">To Date</label>
      <input
        id="toDate"
        type="date"
        value={toDate}
        onChange={(e) => setToDate(e.target.value)}
      />
    </div>
  </div>
</form>


      {filteredCustomers.length > 0 ? (
        <div className="table-container">
<table className="table">
  <thead className="table-dark">
    <tr>
      <th>OrderID</th>
      <th>Name</th>
      <th>Mobile</th>
      {/* <th>Amount</th> */}
      <th>Status</th>
      <th>Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody className="postablebody">
  {filteredCustomers.map((customer, index) => (
  <tr key={index}>
    <td className="fw-bold">{customer.OrderId}</td>
    <td>{customer.UserName || 'N/A'}</td>
    <td>{customer.UserMobile || 'N/A'}</td>
    {/* <td>{amounts[customer.OrderId] || 'N/A'}</td> */}
    <td>{customer.OrderStatus || 'N/A'}</td>
    <td>{formatDate(customer.created_at)}</td>
    <td className="text-center">
      <button className="viewbutton" type="button" onClick={() => handleViewClick(customer.OrderId)}>
        {isModalOpen && selectedOrder.length > 0 && selectedOrder[0]?.OrderId === customer.OrderId ? 'Hide' : 'View'}
      </button>
    </td>
  </tr>
))}


  </tbody>
</table>

        </div>
      ) : (
        <div className="no-customers text-center">
          <div className="my-5"></div>
          <h1>NO RECORD FOUND!</h1>
        </div>
      )}

{isModalOpen && selectedOrder.length > 0 && (
  <div className="modal">
    <div className="modal-content">
      <span className="close" onClick={handleCloseModal}>&times;</span>
      <h4 className='bg-info rounded px-1 py-1'>Order Details</h4>
      <p><strong>OrderID:</strong> {selectedOrder[0]?.OrderId}</p>
      <p><strong>UserName:</strong> {selectedOrder[0]?.UserName || 'N/A'}</p>
      <table className="table table-striped table-hover">
        <thead className='table-dark'>
          <tr>
            <th>Fruit</th>
            <th>Quantity</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
          {selectedOrder.map((item, index) => (
            <tr key={index}>
              <td>{item.Fruit}</td>
              <td>{item.Quantity}</td>
              <td>{item.Price}</td>
            </tr>
          ))}
        </tbody>
      </table>
      <p><strong>TotalAmount : </strong>{selectedOrder.reduce((total, item) => total + parseFloat(item.Price || 0), 0).toFixed(2)}</p>
    </div>
  </div>
)}


      <style jsx>{`
        .table-container {
          max-height: 700px;
          overflow-y: auto;
          height: 499px;
        }
        .postablebody {
          max-height: 400px;
          overflow-y: auto;
          width: 100%;
        }
        .postablebody tr {
          width: 100%;
          table-layout: fixed;
        }
        .postablebody td {
          padding: 8px;
          border: 1px solid #ddd;
        }
        thead {
          position: sticky;
          top: 0;
          background-color: #f1f1f1;
          z-index: 1;
        }
        .viewbutton {
          background-color: #0dcaf0;
        }
        .modal {
          display: ${isModalOpen ? 'flex' : 'none'};
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0, 0, 0, 0.4);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: white;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
          max-width: 500px;
          border-radius: 8px;
        }
        .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
        }
        .close:hover,
        .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
        }

        .status-button {
          background-color: #f1f1f1;
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 10px 20px;
          margin: 5px;
          cursor: pointer;
          outline: none;
          font-size: 16px;
          color: black;
          transition: background-color 0.3s;
        }

        .status-button:hover {
          background-color: #e0e0e0;
        }

        .status-button.active {
          background-color: rgb(75, 181, 67);
          color: white;
          border-color: rgb(237, 232, 232);
        }







  .modal {
    display: flex;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: white;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    border-radius: 8px;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }



      `}</style>
    </div>
  );
}

export default ReportRight;
